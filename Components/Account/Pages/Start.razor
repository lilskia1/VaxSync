@page "/"
@page "/home"
@using MudBlazor
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthState

<PageTitle>VaxSync</PageTitle>

<style>
    .vx-split {
        display: flex;
        min-height: calc(100vh - 64px)
    }

    .vx-left {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #fff;
        background: linear-gradient(135deg,#0B3D91,#1BA1E2);
        text-align: center;
        padding: 2rem
    }

    .vx-right {
        flex: 1;
        position: relative;
        overflow: hidden; /* Add this to contain the image */
    }

        .vx-right img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* This makes the image cover the entire container */
            position: absolute;
            top: 0;
            left: 0;
        }

        .vx-right::after {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(11,61,145,.25)
        }

    .vx-logo {
        width: 150px;
        margin-bottom: 1.5rem
    }

    .vx-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem
    }
</style>

<div class="vx-split">
    <section class="vx-left">
        <img src="images/favicon.png" alt="VaxSync Logo" class="vx-logo" />
        <MudText Typo="Typo.h3" Class="fw-bold">VaxSync student vaccine hub</MudText>
        <MudText Typo="Typo.subtitle1" Class="opacity-75 mb-4">
            Track compliance, view alerts, and export records with confidence.
        </MudText>
    </section>

    <section class="vx-right">
        <img src="images/nurse-student.jpeg" alt="Nurse with student" />
    </section>
</div>


@code {
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = await AuthState.GetAuthenticationStateAsync();
            var authed = state.User?.Identity?.IsAuthenticated == true;

            var target = authed ? ResolveDashboardTarget(state.User) : "/Account/Login";
            var here = new Uri(Nav.Uri).AbsolutePath;

            if (string.Equals(here, target, StringComparison.OrdinalIgnoreCase))
            {
                return;
            }

            Nav.NavigateTo(target, new NavigationOptions
            {
                ReplaceHistoryEntry = true,
                ForceLoad = false
            });
        }
        catch (Microsoft.AspNetCore.Components.NavigationException)
        {
            // harmless during prerender; interactive pass will handle it
        }
        catch
        {
            // let the ErrorBoundary surface details, donâ€™t kill first render
        }
    }

    private static string ResolveDashboardTarget(ClaimsPrincipal user)
    {
        if (user.IsInRole("Admin"))
        {
            return "/admin-dashboard";
        }

        if (user.IsInRole("SchoolNurse"))
        {
            return "/nurse-dashboard";
        }

        if (user.IsInRole("Viewer"))
        {
            return "/viewer-dashboard";
        }

        return "/";
    }
}
